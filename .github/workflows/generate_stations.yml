name: Générer stations.json manuellement

on:
  workflow_dispatch:  # lancement manuel

permissions:
  contents: write     # autorise le push sur le repo

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1) Récupérer le dépôt
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Installer Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

          
      - name: Install dependencies
        run: |
           python -m pip install --upgrade pip
           pip install requests beautifulsoup4

      # 3) Télécharger les données officielles (ZIP "flux instantané")
      #    Réf. open data : https://www.prix-carburants.gouv.fr/rubrique/opendata/
      - name: Download carburant data (XML in ZIP)
        run: |
          set -e
          curl -L -o data.zip "https://donnees.roulez-eco.fr/opendata/instantane"

      # 4) Extraire le XML
      - name: Extract XML
        run: |
          set -e
          unzip -o data.zip
          ls -l

      # 5) Script de conversion XML -> JSON filtré + calculs
      - name: Create convert.py
        run: |
          set -e
          cat > convert.py << 'EOF'
          import xml.etree.ElementTree as ET
          import math
          import requests, time, json
          
          # definition d'un fichier cache pour le nom des enseignes
          ENSEIGNE_CACHE_FILE = "enseigne_cache.json"
          HEADERS = {"User-Agent": "Mozilla/5.0"}

          # --- parseur : extraction pure depuis soup ---
          def extract_enseigne_from_block(soup):
              # 1) ciblage précis d’après ton HTML : <div class="fr-pb-3v">Marque : ...</div>
              block = soup.find("div", class_="fr-pb-3v")
              if block:
                 parts = list(block.stripped_strings)
                 # ["Marque :", "TotalEnergies", "16 bd ...", "44200", "Nantes"]
                 if parts and parts[0].lower().startswith("marque"):
                    parts = parts[1:]
                 if parts:
                    return parts[0].strip()  # "TotalEnergies"
              return ""

          #definition de la fonction get_enseigne pour recuperer le nom de l'enseigne
          def get_enseigne(sid):
              if not sid:
                 return ""
                 
              # 0) cache disque
              cache = {}
              if os.path.exists(ENSEIGNE_CACHE_FILE):
                 try:
                    cache = json.load(open(ENSEIGNE_CACHE_FILE, "r", encoding="utf-8"))
                 except Exception:
                    cache = {}

              if sid in cache and cache[sid]:
                 return cache[sid]

              # 1) requete FTP
              url = f"https://www.prix-carburants.gouv.fr/station/{sid}"
              try:
                 r = requests.get(url, timeout=10, headers={"User-Agent": "Mozilla/5.0"})
                 if r.status_code != 200:
                    return ""

                 soup = BeautifulSoup(r.text, "html.parser")
                 enseigne = extract_enseigne_from_block(soup).strip()

                 ENSEIGNE_CACHE[sid] = enseigne
                 json.dump(ENSEIGNE_CACHE, open(ENSEIGNE_CACHE_FILE, "w", encoding="utf-8"), ensure_ascii=False, indent=2)

                 return enseigne

              except Exception:
                 pass

              return ""

          # --- Paramètres ---
          DEPS = {"78","91","92","93","95"}   # départements à conserver
          REF_LAT, REF_LON = 48.8925, 2.2060  # Nanterre (approx.)
          CONSO = 10                          # L/100 km
          VOLUME = 50                         # L
          FUEL_TAG = "E10"                    # carburant ciblé (E10)

          def haversine(lat1, lon1, lat2, lon2):
              R = 6371
              dlat = math.radians(lat2 - lat1)
              dlon = math.radians(lon2 - lon1)
              a = (math.sin(dlat/2)**2 +
                   math.cos(math.radians(lat1)) *
                   math.cos(math.radians(lat2)) *
                   math.sin(dlon/2)**2)
              return 2 * R * math.asin(math.sqrt(a))

          xml_file = "PrixCarburants_instantane.xml"  # présent dans le ZIP officiel
          tree = ET.parse(xml_file)
          root = tree.getroot()

          stations_out = []

          for pdv in root.findall("pdv"):
              id = pdv.get("id")
              enseigne = get_enseigne(id)
              cp = pdv.get("cp")
              if not cp or cp[:2] not in DEPS:
                  continue

              # Coordonnées WGS84 *100000 -> diviser par 100000
              lat = float(pdv.get("latitude"))/100000
              lon = float(pdv.get("longitude"))/100000

              # Prix carburant ciblé
              prix_elem = None
              for p in pdv.findall("prix"):
                  if p.get("nom") == FUEL_TAG:
                      prix_elem = p
                      break
              if prix_elem is None:
                  continue

              # milli-euros/L -> €/L
              prix = float(prix_elem.get("valeur"))/1000

              dist = haversine(REF_LAT, REF_LON, lat, lon)
              cout_total = prix * VOLUME + (2*dist/100)*CONSO*prix

              # Pour l'affichage, on va chercher adresse/ville si elles existent
              stations_out.append({
                  "station": enseigne, 
                  "adresse": pdv.findtext("adresse") or "",
                  "ville": pdv.findtext("ville") or "",
                  "cp": cp,
                  "prix": prix,
                  "distance": dist,
                  "coutTotal": cout_total
              })

          with open("stations.json", "w", encoding="utf-8") as f:
              json.dump(stations_out, f, ensure_ascii=False, indent=2)

          print("OK : stations.json généré.")
          EOF

      # 6) Exécuter la conversion
      - name: Run convert.py
        run: |
          set -e
          python3 convert.py
          test -f stations.json && echo "stations.json présent"

      # 7) Commit + push uniquement si changements
      - name: Commit and push stations.json (if changed)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add stations.json
          if git diff --cached --quiet; then
            echo "Aucun changement à pousser."
          else
            git commit -m "Mise à jour manuelle stations.json"
            git push
          fi
