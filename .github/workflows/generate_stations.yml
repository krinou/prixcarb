name: Générer stations.json manuellement

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # 1) Récupérer le dépôt
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Installer Python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 2.1) Installer requests
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # 3) Télécharger le flux instantané (ZIP)
      # Réf. ancienne page open data : https://www.prix-carburants.gouv.fr/rubrique/opendata/
      - name: Download carburant data (XML in ZIP)
        run: |
          set -e
          curl -L -o data.zip "https://donnees.roulez-eco.fr/opendata/instantane"

      # 4) Extraire le XML
      - name: Extract XML
        run: |
          set -e
          unzip -o data.zip
          ls -l

      # 5) Script de conversion (avec 2aaz pour les enseignes)
      - name: Create convert.py
        run: |
          set -e
          cat > convert.py << 'EOF'
          # (==> COLLer ICI le script Python corrigé fourni plus haut <==)
          EOF

      # 6) Exécuter la conversion
      - name: Run convert.py
        run: |
          set -e
          python3 convert.py
          test -f stations.json && echo "stations.json présent"

      # 7) Commit + push uniquement si changements
      - name: Commit and push stations.json (if changed)
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add stations.json brand_cache.json || true
          if git diff --cached --quiet; then
            echo "Aucun changement à pousser."
          else
            git commit -m "Mise à jour manuelle stations.json (+ cache enseignes)"
            git push
          fi
