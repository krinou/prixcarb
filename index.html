<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Stations – Classement pondéré depuis Nanterre</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
  table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  th { background: #eee; }
  .loading { font-size: 18px; color: #555; }
  .error { color: #b00020; font-weight: bold; white-space: pre-wrap; }

  // style petites fleches pour le tri 
  th.sortable-header { cursor: pointer; user-select: none; }
  th.sort-asc::after  { content: " ▲"; font-size: 0.9em; color: #666; }
  th.sort-desc::after { content: " ▼"; font-size: 0.9em; color: #666; }

</style>
</head>
<body>

<h1>⛽ Classement des stations pondéré (E10) – Nanterre</h1>
<div id="status" class="loading">⏳ Chargement…</div>

<table id="table" class="sortable" style="display:none;">
  <thead>
    <tr>
      <th>Rang</th>
      <th>Station</th>
      <th>Adresse</th>
      <th>CP</th>
      <th>Ville</th>
      <th>Prix (€/L)</th>
      <th>Distance (km)</th>
      <th>Coût total (€)</th>
      <th>Prix pondéré (€/L)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
async function charger() {
  const status = document.getElementById("status");
  try {
    const res  = await fetch("stations.json", { cache: "no-cache" });
    const rows = await res.json();

    // Paramètres
    const CONSO  = 10;
    const VOLUME = 50;

    // Préparer données enrichies
    const data = rows.map(r => {
      const pRaw    = typeof r.prix === "number" ? r.prix : Number(r.prix);
      const prixEur = Number.isFinite(pRaw) ? (pRaw < 0.1 ? pRaw * 1000 : pRaw) : 0;

      const dRaw    = typeof r.distance === "number" ? r.distance : Number(r.distance);
      const distKm  = Number.isFinite(dRaw) ? dRaw : 0;

      const coutTotal   = prixEur * VOLUME + ((2 * distKm / 100) * CONSO * prixEur);
      const prixPondere = coutTotal / VOLUME;

      return {
        station: "",        // blanc comme tu veux
        adresse: (typeof r.station === "string") ? r.station.trim() : "",
        cp: r.cp ?? "",
        ville: r.ville ?? "",
        prix: prixEur,
        distance: distKm,
        prixTotal: coutTotal,
        prixPondere
      };
    });

    // Charger config tri mémorisée
    let triCol = localStorage.getItem("triCol") ?? "prixPondere";
    let triDir = localStorage.getItem("triDir") ?? "asc";

    // Appliquer tri au chargement
    trierData(data, triCol, triDir);

    // Affichage
    const table = document.getElementById("table");
    const tbody = table.querySelector("tbody");
    remplirTableau(data, tbody);

    // Activer tri
    setupTri(table, data);

    status.style.display = "none";
    table.style.display  = "table";

  } catch (e) {
    document.getElementById("status").textContent =
      "❌ Erreur lors du chargement : " + (e.message || e);
    console.error(e);
  }
}


// ----------------------------
//   CONSTRUCTION D’UNE LIGNE
// ----------------------------
function buildRow(r, index) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${index+1}</td>
    <td>${r.station}</td>
    <td>${r.adresse}</td>
    <td>${r.cp}</td>
    <td>${r.ville}</td>
    <td>${r.prix.toFixed(3)}</td>
    <td>${r.distance.toFixed(2)}</td>
    <td>${r.prixTotal.toFixed(2)}</td>
    <td>${r.prixPondere.toFixed(3)}</td>
  `;
  return tr;
}

function remplirTableau(data, tbody) {
  tbody.innerHTML = "";
  data.forEach((r, i) => tbody.appendChild(buildRow(r, i)));
}


// -----------------------------------------
//   ALGORITHME DE TRI MULTI-CRITERES
// -----------------------------------------
function trierData(data, col, dir) {

  data.sort((a, b) => {

    const cmp = compare(a[col], b[col], dir);

    if (cmp !== 0) return cmp;

    // 2) Distance
    const cmp2 = compare(a.distance, b.distance, "asc");
    if (cmp2 !== 0) return cmp2;

    // 3) Prix simple
    const cmp3 = compare(a.prix, b.prix, "asc");
    if (cmp3 !== 0) return cmp3;

    return 0;
  });
}


// -----------------------------------------
//    COMPARATEUR DE BASE
// -----------------------------------------
function compare(a, b, dir) {
  const na = Number(a);
  const nb = Number(b);
  const res = na - nb;
  return dir === "asc" ? res : -res;
}


// -----------------------------------------
//   ACTIVATION DU TRI SUR 3 COLONNES
// -----------------------------------------
function setupTri(table, data) {

  // Colonnes utilisables : Prix, Distance, Prix total, Prix pondéré
  // Indices : 5, 6, 7, 8
  const COLMAP = {
    5: "prix",
    6: "distance",
    7: "prixTotal",
    8: "prixPondere"
  };

  const headers = table.querySelectorAll("th");
  const tbody   = table.querySelector("tbody");

  headers.forEach((th, idx) => {

    if (!(idx in COLMAP)) return; // ignorer autres colonnes

    th.classList.add("sortable-header");

    th.addEventListener("click", () => {

      const col = COLMAP[idx];

      // Charger ancienne direction
      let dir = localStorage.getItem("triDir");
      let lastCol = localStorage.getItem("triCol");

      // Alterner si même colonne
      if (lastCol === col) {
        dir = dir === "asc" ? "desc" : "asc";
      } else {
        dir = "asc";
      }

      // Stocker
      localStorage.setItem("triCol", col);
      localStorage.setItem("triDir", dir);

      // Appliquer
      trierData(data, col, dir);
      remplirTableau(data, tbody);

      // Mettre à jour les flèches
      headers.forEach(h => h.classList.remove("sort-asc", "sort-desc"));
      th.classList.add(dir === "asc" ? "sort-asc" : "sort-desc");
    });
  });

}
</script>
</body>
</html>
