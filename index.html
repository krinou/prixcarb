<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Stations – Classement pondéré depuis Nanterre</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
  table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  th { background: #eee; }
  .loading { font-size: 18px; color: #555; }
  .error { color: #b00020; font-weight: bold; white-space: pre-wrap; }
</style>
</head>
<body>

<h1>⛽ Classement des stations pondéré (E10) – Nanterre</h1>
<div id="status" class="loading">⏳ Chargement…</div>

<table id="table" style="display:none;">
  <thead>
    <tr>
      <th>Rang</th>
      <th>Station</th>
      <th>Adresse</th>
      <th>CP</th>
      <th>Ville</th>
      <th>Prix (€/L)</th>
      <th>Distance (km)</th>
      <th>Coût total (€)</th>
      <th>Prix pondéré (€/L)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
async function charger() {
  const status = document.getElementById("status");
  try {
    const res = await fetch("stations.json", { cache: "no-cache" });
    const rows = await res.json();

    // Paramètres de pondération
    const CONSO  = 10;   // L/100 km
    const VOLUME = 50;   // L

    // Préparation : on corrige le prix si besoin, on recalcule prix total et pondéré
    const enriched = rows.map(r => {
      // 1) Prix (€/L) : si <0.1, on considère milli-euros -> x1000 ; sinon on garde
      const pRaw     = typeof r.prix === "number" ? r.prix : Number(r.prix);
      const prixEur  = Number.isFinite(pRaw) ? (pRaw < 0.1 ? pRaw * 1000 : pRaw) : 0;

      // 2) Distance (km)
      const dist     = typeof r.distance === "number" ? r.distance : Number(r.distance);
      const distKm   = Number.isFinite(dist) ? dist : 0;

      // 3) Coûts
      const coutTotal = (prixEur * VOLUME) + ((2 * distKm / 100) * CONSO * prixEur);
      const prixPondere = coutTotal / VOLUME;

      // 4) Colonnes d'affichage
      const stationName = ""; // Station en blanc, comme souhaité
      const adresseAff  = (typeof r.station === "string") ? r.station.trim() : (r.station ?? "");
      const cpAff       = r.cp ?? "";
      const villeAff    = r.ville ?? "";

      return {
        stationName,
        adresseAff,
        cpAff,
        villeAff,
        prixEur,
        distKm,
        coutTotal,
        prixPondere
      };
    });

    // Tri par prix pondéré (du meilleur au moins bon)
    enriched.sort((a,b) => a.prixPondere - b.prixPondere);

    // Injection dans le tableau
    const tbody = document.querySelector("#table tbody");
    tbody.innerHTML = "";

    enriched.forEach((r, i) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${i+1}</td>
        <td>${r.stationName}</td>                         <!-- Station : blanc -->
        <td>${r.adresseAff}</td>                          <!-- Adresse -->
        <td>${r.cpAff}</td>
        <td>${r.villeAff}</td>
        <td>${r.prixEur.toFixed(3)}</td>                  <!-- 1 entier + 3 décimales -->
        <td>${r.distKm.toFixed(2)}</td>
        <td>${r.coutTotal.toFixed(2)}</td>                <!-- Prix total (€) -->
        <td>${r.prixPondere.toFixed(3)}</td>              <!-- Prix pondéré (€/L) -->
      `;
      tbody.appendChild(tr);
    });

    status.style.display = "none";
    document.getElementById("table").style.display = "table";
  } catch (e) {
    document.getElementById("status").textContent =
      "❌ Erreur lors du chargement : " + (e.message || e);
    console.error(e);
  }
}
charger();
</script>
</body>
</html>
