<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Stations – Classement carburants</title>

<!-- Bootstrap 5 (mise en forme professionnelle) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  th.sortable-header { cursor: pointer; user-select: none; }
  th.sort-asc::after  { content: " ▲"; font-size: 0.9em; color: #666; }
  th.sort-desc::after { content: " ▼"; font-size: 0.9em; color: #666; }
</style>

</head>
<body class="bg-light">

<div class="container mt-4 mb-5">

  <h1 class="mb-4 text-center">⛽ Classement des stations</h1>

  <div id="status" class="alert alert-info text-center">⏳ Chargement…</div>

  <table id="table" class="table table-striped table-hover table-bordered align-middle" style="display:none;">
    <thead class="table-dark">
      <tr>
        <th>Rang</th>
        <th>Station</th>
        <th>Adresse</th>
        <th>CP</th>
        <th>Ville</th>
        <th>Prix (€/L)</th>
        <th>Distance (km)</th>
        <th>Prix total (€)</th>
        <th>Prix pondéré (€/L)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>


<script>
// --------------------------------------------------
// Chargement JSON + Calculs + Tri + Affichage
// --------------------------------------------------

async function charger() {
  const status = document.getElementById("status");
  const table  = document.getElementById("table");

  try {
    const res = await fetch("stations.json", { cache:"no-cache" });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const rows = await res.json();
    if (!Array.isArray(rows)) throw new Error("JSON invalide");

    const CONSO  = 10;   // L/100 km
    const VOLUME = 50;   // L

    // Convertit les données brutes en données affichables
    const data = rows.map(r => {
      // Prix (corriger milli‑euros si <0.1)
      const pRaw    = (typeof r.prix === "number") ? r.prix : Number(r.prix);
      const prixEur = Number.isFinite(pRaw) ? (pRaw < 0.1 ? pRaw*1000 : pRaw) : 0;

      // Distance
      const dRaw    = (typeof r.distance === "number") ? r.distance : Number(r.distance);
      const distKm  = Number.isFinite(dRaw) ? dRaw : 0;

      // Coût total & Prix pondéré
      const coutTotal   = prixEur*VOLUME + ((2*distKm/100)*CONSO*prixEur);
      const prixPondere = coutTotal / VOLUME;

      return {
        station    : "",  // vide (comme souhaité)
        adresse    : (typeof r.station === "string") ? r.station.trim() : "",
        cp         : r.cp ?? "",
        ville      : r.ville ?? "",
        prix       : prixEur,
        distance   : distKm,
        prixTotal  : coutTotal,
        prixPondere: prixPondere
      };
    });

    // Charger tri mémorisé
    let triCol = localStorage.getItem("triCol") ?? "prixPondere";
    let triDir = localStorage.getItem("triDir") ?? "asc";

    appliquerTri(data, triCol, triDir);

    // Afficher lignes
    const tbody = table.querySelector("tbody");
    remplirTableau(data, tbody);

    // Activer tri cliquable
    activerTri(table, data, triCol, triDir);

    status.style.display = "none";
    table.style.display  = "table";

  } catch (e) {
    if (status) status.textContent = "❌ Erreur : " + e.message;
    console.error(e);
  }
}


// --------------------------------------------------
// Construction visuelle d'une ligne <tr>
// --------------------------------------------------

function buildRow(obj, i) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${i+1}</td>
    <td>${obj.station}</td>
    <td>${obj.adresse}</td>
    <td>${obj.cp}</td>
    <td>${obj.ville}</td>
    <td>${obj.prix.toFixed(3)}</td>
    <td>${obj.distance.toFixed(2)}</td>
    <td>${obj.prixTotal.toFixed(2)}</td>
    <td>${obj.prixPondere.toFixed(3)}</td>
  `;
  return tr;
}

function remplirTableau(data, tbody) {
  tbody.innerHTML = "";
  data.forEach((o,i) => tbody.appendChild(buildRow(o,i)));
}


// --------------------------------------------------
// Tri principal + tri secondaire + tri tertiaire
// --------------------------------------------------

function appliquerTri(data, col, dir) {
  const sens = (dir === "asc" ? 1 : -1);

  data.sort((a,b) => {
    // 1) Tri principal
    const c1 = compare(a[col], b[col]) * sens;
    if (c1 !== 0) return c1;

    // 2) Tri secondaire : distance
    const c2 = compare(a.distance, b.distance);
    if (c2 !== 0) return c2;

    // 3) Tri tertiaire : prix simple
    const c3 = compare(a.prix, b.prix);
    return c3;
  });
}

function compare(a,b) {
  const na = Number(a), nb = Number(b);
  if (!Number.isFinite(na) && !Number.isFinite(nb)) return 0;
  if (!Number.isFinite(na)) return 1;
  if (!Number.isFinite(nb)) return -1;
  return na - nb;
}


// --------------------------------------------------
// Activer le tri SUR 3 COLONNES SEULEMENT :
// Prix (col 5), Distance (6), Prix pondéré (8)
// --------------------------------------------------

function activerTri(table, data, triCol, triDir) {
  const tbody   = table.querySelector("tbody");
  const headers = table.querySelectorAll("th");

  // colonnes triables (alignées sur ton <thead>)
  const COL = {
    5: "prix",
    6: "distance",
    8: "prixPondere"
  };

  // marquage visuel
  Object.entries(COL).forEach(([idx,key]) => {
    headers[idx].classList.add("sortable-header");
    if (key === triCol) headers[idx].classList.add(triDir === "asc" ? "sort-asc" : "sort-desc");
  });

  headers.forEach((th, idx) => {
    if (!(idx in COL)) return; // ignorer autres colonnes

    const key = COL[idx];

    th.addEventListener("click", () => {
      let col = key;
      let oldCol = localStorage.getItem("triCol") ?? "prixPondere";
      let oldDir = localStorage.getItem("triDir") ?? "asc";

      // sens du tri
      let dir = (oldCol === col) ? (oldDir==="asc"?"desc":"asc") : "asc";

      // mémoriser
      localStorage.setItem("triCol", col);
      localStorage.setItem("triDir", dir);

      // appliquer tri
      appliquerTri(data, col, dir);
      remplirTableau(data, tbody);

      // mettre à jour flèches
      headers.forEach(h=>h.classList.remove("sort-asc","sort-desc"));
      th.classList.add(dir==="asc" ? "sort-asc":"sort-desc");
    });
  });
}

charger();
</script>

</body>
</html>
