<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Stations – Classement pondéré depuis Nanterre</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
  h1 { color: #333; }
  table { border-collapse: collapse; width: 100%; margin-top: 20px; background: #fff; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  th { background: #eee; }
  .loading { font-size: 18px; color: #666; }
  .error { color: #b00020; font-weight: bold; white-space: pre-wrap; }
</style>
</head>
<body>

<h1>⛽ Classement pondéré des stations autour de Nanterre</h1>
<p>Carburant : <b>E10</b> – Volume : <b>50 L</b> – Conso : <b>10 L/100 km</b></p>

<div id="status" class="loading">⏳ Chargement…</div>

<table id="table" style="display:none;">
  <thead>
    <tr>
      <th>Rang</th><th>Station</th><th>Adresse</th><th>CP</th>
      <th>Ville</th><th>Prix (€/L)</th><th>Distance (km)</th><th>Coût total (€)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
// ===== Paramètres =====
const REF_LAT = 48.8925;
const REF_LON = 2.2060;
const DEPS = ["78", "91", "92", "93", "95"];
const CONSO = 10;   // L/100km
const VOLUME = 50;  // L
const FUEL = "E10"; // "E10", "SP95", "SP98", "Gazole", "E85", "GPLc"

// ===== Distance Haversine (km) =====
function haversine(lat1, lon1, lat2, lon2) {
  const R = 6371;
  const dLat = (lat2 - lat1) * Math.PI/180;
  const dLon = (lon2 - lon1) * Math.PI/180;
  const a = Math.sin(dLat/2)**2 +
            Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
            Math.sin(dLon/2)**2;
  return 2 * R * Math.asin(Math.sqrt(a));
}

// ===== Chargement (API 2Aaz, CORS ok) =====
async function charger() {
  const status = document.getElementById('status');
  try {
    // API réutilisation (CORS ouvert) : https://www.data.gouv.fr/fr/reuses/api-prix-carburants/
    // Endpoint de stations au format opendata (lat/lon, prix par carburant, etc.)
    const url = "https://api.prix-carburants.2aaz.fr/opendata/stations";
    const resp = await fetch(url, { headers: { "Accept": "application/json" } });

    if (!resp.ok) {
      throw new Error(`HTTP ${resp.status} ${resp.statusText}`);
    }
    const stations = await resp.json();

    const rows = stations
      .filter(s => s.cp && DEPS.includes(String(s.cp).substring(0,2)))
      .filter(s => s.position && typeof s.position.lat === "number" && typeof s.position.lon === "number")
      .filter(s => s.prix && typeof s.prix[FUEL] === "number" && s.prix[FUEL] > 0)
      .map(s => {
        const prix = s.prix[FUEL];
        const dist = haversine(REF_LAT, REF_LON, s.position.lat, s.position.lon);
        const coutTotal = prix * VOLUME + (2 * dist / 100) * CONSO * prix;
        return {
          station: s.nom || "",
          adresse: s.adresse || "",
          cp: s.cp || "",
          ville: s.ville || "",
          prix,
          distance: dist,
          coutTotal
        };
      })
      .sort((a,b) => a.coutTotal - b.coutTotal);

    afficher(rows);
  } catch (e) {
    status.className = "error";
    status.textContent = "❌ Erreur lors du chargement des données : " + (e && e.message ? e.message : e);
    console.error(e);
  }
}

function afficher(rows) {
  const status = document.getElementById('status');
  const table = document.getElementById('table');
  const tbody = table.querySelector("tbody");

  tbody.innerHTML = "";
  rows.forEach((r, i) => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${i+1}</td>
      <td>${r.station}</td>
      <td>${r.adresse}</td>
      <td>${r.cp}</td>
      <td>${r.ville}</td>
      <td>${r.prix.toFixed(3)}</td>
      <td>${r.distance.toFixed(2)}</td>
      <td>${r.coutTotal.toFixed(2)}</td>`;
    tbody.appendChild(tr);
  });

  status.style.display = "none";
  table.style.display = "table";
}

charger();
</script>

</body>
</html>
