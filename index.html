<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<title>Stations ‚Äì Classement pond√©r√© depuis Nanterre</title>
<style>
  body { font-family: Arial, sans-serif; margin: 20px; background: #f4f4f4; }
  table { border-collapse: collapse; width: 100%; background: #fff; margin-top: 20px; }
  th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
  th { background: #eee; }
  .loading { font-size: 18px; color: #555; }
  .error { color: #b00020; font-weight: bold; white-space: pre-wrap; }

  // style petites fleches pour le tri 
  th.sortable-header { cursor: pointer; user-select: none; }
  th.sort-asc::after  { content: " ‚ñ≤"; font-size: 0.9em; color: #666; }
  th.sort-desc::after { content: " ‚ñº"; font-size: 0.9em; color: #666; }

</style>
</head>
<body>

<h1>‚õΩ Classement des stations pond√©r√© (E10) ‚Äì Nanterre</h1>
<div id="status" class="loading">‚è≥ Chargement‚Ä¶</div>

<table id="table" class="sortable" style="display:none;">
  <thead>
    <tr>
      <th>Rang</th>
      <th>Station</th>
      <th>Adresse</th>
      <th>CP</th>
      <th>Ville</th>
      <th>Prix (‚Ç¨/L)</th>
      <th>Distance (km)</th>
      <th>Co√ªt total (‚Ç¨)</th>
      <th>Prix pond√©r√© (‚Ç¨/L)</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
async function charger() {
  const status = document.getElementById("status");      // peut √™tre null
  const table  = document.getElementById("table");       // peut √™tre null

  try {
    if (!table) {
      console.warn("üü° Pas de #table dans le DOM.");
      if (status) status.textContent = "‚ùå Table manquante (#table).";
      return;
    }

    const tbody = table.querySelector("tbody");
    if (!tbody) {
      console.warn("üü° Pas de <tbody> dans #table.");
      if (status) status.textContent = "‚ùå Corps de tableau manquant.";
      return;
    }

    const res = await fetch("stations.json", { cache: "no-cache" });
    if (!res.ok) throw new Error(`HTTP ${res.status} ${res.statusText}`);

    const rows = await res.json();
    if (!Array.isArray(rows)) throw new Error("stations.json n'est pas un tableau JSON.");

    // Param√®tres
    const CONSO  = 10;
    const VOLUME = 50;

    // Pr√©parer donn√©es enrichies (et robustifier les valeurs)
    const data = rows.map((r,i) => {
      const pRaw    = (typeof r.prix === "number") ? r.prix : Number(r.prix);
      const prixEur = Number.isFinite(pRaw) ? (pRaw < 0.1 ? pRaw * 1000 : pRaw) : 0;

      const dRaw    = (typeof r.distance === "number") ? r.distance : Number(r.distance);
      const distKm  = Number.isFinite(dRaw) ? dRaw : 0;

      const coutTotal   = (prixEur * VOLUME) + ((2 * distKm / 100) * CONSO * prixEur);
      const prixPondere = coutTotal / VOLUME;

      return {
        station: "", // blanc, comme souhait√©
        adresse: (typeof r.station === "string") ? r.station.trim() : (r.station ?? ""),
        cp: r.cp ?? "",
        ville: r.ville ?? "",
        prix: prixEur,
        distance: distKm,
        prixTotal: coutTotal,
        prixPondere
      };
    });

    // Lire tri m√©moris√© (par d√©faut: prix pond√©r√© asc)
    let triCol = localStorage.getItem("triCol") ?? "prixPondere";
    let triDir = localStorage.getItem("triDir") ?? "asc";

    trierData(data, triCol, triDir);

    // Afficher
    remplirTableau(data, table.querySelector("tbody"));

    // Activer tri (seulement sur Prix, Distance, Prix pond√©r√©)
    safeEnableSorting(table, data, triCol, triDir);

    if (status) status.style.display = "none";
    table.style.display = "table";
  } catch (e) {
    console.error(e);
    if (status) {
      status.textContent = "‚ùå Erreur : " + (e.message || e);
      status.style.display = "block";
    }
  }
}

// Construit une ligne
function buildRow(r, i) {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td>${i+1}</td>
    <td>${r.station}</td>
    <td>${r.adresse}</td>
    <td>${r.cp}</td>
    <td>${r.ville}</td>
    <td>${r.prix.toFixed(3)}</td>
    <td>${r.distance.toFixed(2)}</td>
    <td>${r.prixTotal.toFixed(2)}</td>
    <td>${r.prixPondere.toFixed(3)}</td>
  `;
  return tr;
}

function remplirTableau(data, tbody) {
  tbody.innerHTML = "";
  data.forEach((r, i) => tbody.appendChild(buildRow(r, i)));
}

// Tri multi-crit√®res : col principale, puis distance, puis prix simple
function trierData(data, col, dir) {
  const sens = (dir === "asc") ? 1 : -1;

  data.sort((a, b) => {
    const p = cmp(a[col], b[col]) * sens;
    if (p !== 0) return p;

    const q = cmp(a.distance, b.distance); // asc
    if (q !== 0) return q;

    const r = cmp(a.prix, b.prix);         // asc
    return r;
  });
}

function cmp(a, b) {
  const na = Number(a), nb = Number(b);
  if (!Number.isFinite(na) && !Number.isFinite(nb)) return 0;
  if (!Number.isFinite(na)) return 1;
  if (!Number.isFinite(nb)) return -1;
  return na - nb;
}

// Active tri uniquement sur Prix (col 5), Distance (6), Prix pond√©r√© (8)
function safeEnableSorting(table, data, currentCol, currentDir) {
  const thead = table.querySelector("thead");
  const tbody = table.querySelector("tbody");
  if (!thead || !tbody) {
    console.warn("üü° thead/tbody manquants : tri d√©sactiv√©.");
    return;
  }

  const headers = Array.from(thead.querySelectorAll("th"));
  if (headers.length < 9) {
    console.warn("üü° Ent√™te inattendu (moins de 9 colonnes) : tri d√©sactiv√©.");
    return;
  }

  // Ajoute le CSS si absent (facultatif si tu l'as d√©j√†)
  headers.forEach(h => h.classList.remove("sort-asc","sort-desc","sortable-header"));

  // mapping index -> cl√© (0-based, conforme √† ton thead actuel)
  const ALLOWED = {
    5: "prix",         // Prix (‚Ç¨/L)
    6: "distance",     // Distance (km)
    8: "prixPondere"   // Prix pond√©r√© (‚Ç¨/L)
  };

  // Positionner fl√®che initiale si on est sur une colonne autoris√©e
  const idxInit = Object.entries(ALLOWED).find(([idx,key]) => key === currentCol)?.[0];
  if (idxInit !== undefined) {
    const initHeader = headers[Number(idxInit)];
    if (initHeader) initHeader.classList.add(currentDir === "asc" ? "sort-asc" : "sort-desc");
  }

  headers.forEach((th, idx) => {
    const key = ALLOWED[idx];
    if (!key) return; // colonne non triable

    th.classList.add("sortable-header");

    th.addEventListener("click", () => {
      // Charger anciens choix
      let lastCol = localStorage.getItem("triCol") ?? "prixPondere";
      let lastDir = localStorage.getItem("triDir") ?? "asc";

      // D√©terminer nouveau sens
      let dir = (lastCol === key) ? (lastDir === "asc" ? "desc" : "asc") : "asc";

      // M√©moriser
      localStorage.setItem("triCol", key);
      localStorage.setItem("triDir", dir);

      // Appliquer tri + r√©affichage
      trierData(data, key, dir);
      remplirTableau(data, tbody);

      // Fl√®ches
      headers.forEach(h => h.classList.remove("sort-asc","sort-desc"));
      th.classList.add(dir === "asc" ? "sort-asc" : "sort-desc");
    });
  });
}

// Lancer
charger();
</script>
</body>
</html>
